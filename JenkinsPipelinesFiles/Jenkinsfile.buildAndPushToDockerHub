pipeline {
    agent { label 'dockerNode' }



    stages {
  



        stage('Build Image and Run Tests') {
            steps {
                echo "‚û°Ô∏è Starting Stage: Build Image and Run Tests"
                echo "‚úÖ WORKSPACE: ${env.WORKSPACE}"
                script {
                    def workspacePath = env.WORKSPACE
                    // Pass WORKSPACE into docker-compose
                    withEnv(["WORKSPACE=${workspacePath}"]) {
                        bat "docker compose up --build --abort-on-container-exit --exit-code-from selenium-test-runner"
                    }
                }
                echo "‚úÖ Completed Stage: Build Image and Run Tests"
            }
        }



        stage('Push Image') {
            steps {
                echo "‚û°Ô∏è Starting Stage: Push Image"
                withCredentials([usernamePassword(credentialsId: 'dockerHubCredentials', passwordVariable: 'pass', usernameVariable: 'user')]) {
                    bat "docker login --username=${user} --password=${pass}"
                    bat "docker push osamazaza/sage:latest"
                }
                echo "‚úÖ Completed Stage: Push Image"
            }
        }
    }



    post {
        always {
            echo "üßπ Cleaning up containers"
            bat 'docker compose down || echo "Nothing to clean"'



            echo "üìä Publishing latest HTML report from host"
            script {
                try {
                    // Find all HTML files in the report directory
                    def reportFiles = findFiles(glob: 'Reports/CustomReport/*.html')
                    if (reportFiles) {
                        // Manually find the newest file
                        def newestFile = null
                        def latestTime = 0
                        reportFiles.each { file ->
                            if (file.lastModified > latestTime) {
                                latestTime = file.lastModified
                                newestFile = file
                            }
                        }



                        if (newestFile) {
                            echo "üìÑ Latest report found: ${newestFile.name}"
                            publishHTML(target: [
                                allowMissing: false,
                                alwaysLinkToLastBuild: true,
                                keepAll: true,
                                reportDir: "Reports/CustomReport",
                                reportFiles: newestFile.name,
                                reportName: 'Latest Test Report'
                            ])
                        }
                    } else {
                        echo "‚ö†Ô∏è No HTML report found to publish."
                    }
                } catch (Exception e) {
                    echo "‚ùå An error occurred while publishing the report: ${e.message}"
                }
            }
        }
    }
}